<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./stylesheets/bootstrap.min.css">

    <script src="./lib/convnet-min.js"></script>
    <script src="./lib/20160515-convnet-param.js"></script>
    <script src="./lib/20160515-convnet-example-data.js"></script>

<style>

    html {
        font-family: Lucida Grande, sans-serif;
        -ms-text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
    }

    .panel {
        overflow: auto;
    }

</style>

</head>

<body>

    <!--Header-->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container-fluid">

            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">Code Snippet Classifier</a>
            </div>

            <div class="navbar-collapse navbar-responsive-collapse">

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="./src/about.html">About</a></li>
                </ul>

            </div>
        </div>
    </nav>

    <!--Body-->
    <div class="container">
        <div class="panel-group">

            <!--Input Box-->
            <div class="col-xs-4"><div class="panel panel-default">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <span class="label label-default" align="left">Input</span>
                        <span class="label label-success" align="left">Python</span>
                    </div>

                    <div class="panel-title pull-right">
                        <a onclick="onclick_handler('1')"><span class="label label-default" align="left">Random</span></a>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body">
                    <div class="form-group">
                        <textarea id="user_input" onkeyup="onkey_handler(event)" onpaste="outputLabel([])" class="form-control" rows="10" style="min-height: 325px;" placeholder="Paste code snippet here..."></textarea>
                    </div>

                    <button type="button" onclick="onclick_handler([])" class="btn btn-primary btn-sm btn-block">Submit</button>

                </div>

            </div></div>

            <!--Output Box-->
            <div class="col-xs-8"><div class="panel panel-primary">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <span class="label label-default" align="left">Output</span>
                    </div>

                    <div class="panel-title pull-right">
                        <span class="label label-danger">Demo</span>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body" style="min-height: 325px; word-wrap: break-word">
                    <div id="user_output"></div>
                </div>

            </div></div>

        </div>
    </div>

    <br>&nbsp;<br>

</body>

<script>

//
// Input callback
//
var onclick_handler = function(input) {

    if (input.length == 0) {
        input = document.getElementById("user_input").value

    } else {

        switch (input) {
            case '1':
                dataIndex = Math.floor(Math.random() * 499);
                input = exampleData[dataIndex].postText
                break
            default:
                return
        }

        document.getElementById("user_input").value = input
    }

    // Preprocess text
    var text = []

    if (input.length > 0) {
        text = parseInput(input)

        var data = new convnetjs.Vol(50, 25, 1, 0.0);
        data = formatData(text, data)

        var testData = net.forward(data)
        var testIndex = []

        for (var j = 0; j < testData.w.length; j++) {
            if (testData.w[j] > 0.01) {
                testIndex.push(j)
            }
        }

        outputLabel(testIndex)
    }
}

//
// Keyboard callback
//
var onkey_handler = function(event) {

    // Check if input is empty
    if (document.getElementById("user_input").value == "") {
        outputLabel([])
    }
}

//
// Load network
//
var loadNetwork = function () {

    var net = new convnetjs.Net();
    net.fromJSON(netParam);

    return net
}

//
// Parse input
//
var parseInput = function () {

    input = document.getElementById("user_input").value

    //
    // Text preprocessing
    //
    text  = []

    grammar = /([a-z0-9.,;:'"<>{}\(\)!?\[\]\-\+\*\^\#\!\&\_\=\/\|\`\~\\]+)/gi

    // 1) Remove all spaces (keep newline and tabs)
    if (input.length > 0) {
        input = input.replace(/[ ]+/g, '')
    } else {
        return
    }

    // 2) Convert to lower case
    if (input.length > 0) {
        input = input.toLowerCase(text)
    } else {
        return
    }

    // 3) Check for " at start/end (artifacts of copy/paste)
    if (input.charAt(0) == '"') {
        input = input.substr(1)
    }

    if (input.charAt(input.length-1) == '"') {
        input = input.substr(0, input.length-1)
    }

    // 4) Parse input (group by lines, max length of 50 characters)
    while ((x = grammar.exec(input))) {
        text.push(x[0].substr(0,50))
    }

    // 5) Keep the first 25 lines
    if (text.length > 25) {
        text = text.slice(0, 24)
    }

    // 6) Convert characters to integers (char --> charcode)
    var output = []

    for (var i = 0; i < text.length; i++) {
        for (var j = 0; j < text[i].length; j++) {

            if (j == 0) {
                output[i] = []
            }

            output[i].push(text[i].charCodeAt(j))
        }
    }

    // 7) Zero padding (fill each array to 50 total elements with zeros)
    for (var i = 0; i < output.length; i++) {

        if (output[i].length < 50) {
            var x = output[i].length

            for (var j = 0; j < 50 - x; j++) {
                output[i].push(0)
            }
        }
    }

    return output
}

//
// Format data
//
var formatData = function (input, data) {

    for (var i = 0; i < input.length; i++) {
        for (var j = 0; j < input[i].length; j++) {
            data.set(i, j, 1, input[i][j])
        }
    }

    return data
}

//
// Parse output
//
var getLabel = function(output) {

    if (output >= 1 & output <= 250) {
        return labelKey[output-1]
    } else {
        return ""
    }
}

//
// Classification table
//
var outputLabel = function (input) {

    var x = ' '

    // Construct HTML table
    for (var i = 0; i < labelKey.length; i++) {

        if (input.indexOf(i+1) >= 0) {
            x = x.concat('<span class="label label-success">', labelKey[i], '</span>\n')
        } else {
            x = x.concat('<span class="label label-default">', labelKey[i], '</span>\n')
        }
    }

    // Update HTML table
    document.getElementById("user_output").innerHTML = x

}

//
// Label keys
//
var labelKey = [
    "django", "numpy", "pandas", "python-2.7", "list", "python-3.x", "matplotlib", "regex", "dictionary", "string",
    "arrays", "flask", "google-app-engine", "sqlalchemy", "scipy", "tkinter", "csv", "django-models", "json", "beautifulsoup",
    "mysql", "multithreading", "pip", "datetime", "subprocess", "scrapy", "unicode", "xml", "linux", "html", "unit-testing",
    "selenium", "performance", "class", "multiprocessing", "algorithm", "windows", "dataframe", "sorting", "c++", "osx",
    "opencv", "pyqt", "file", "function", "scikit-learn", "pygame", "parsing", "list-comprehension", "virtualenv", "logging",
    "sockets", "import", "tuples", "loops", "web-scraping", "django-templates", "mongodb", "lxml", "postgresql", "plot",
    "sql", "ipython", "javascript", "python-imaging-library", "module", "c", "django-rest-framework", "exception", "for-loop", "recursion", "cython",
    "oop", "python-requests", "django-forms", "django-admin", "wxpython", "argparse", "celery", "bash", "qt", "pyqt4",
    "ctypes", "matrix", "selenium-webdriver", "generator", "math", "decorator", "sqlite", "urllib2", "jinja2", "shell", "nltk",
    "file-io", "random", "inheritance", "python-import", "setuptools", "twisted", "image", "xpath", "python-2.x", "flask-sqlalchemy",
    "variables", "database", "excel", "pymongo", "machine-learning", "syntax", "utf-8", "encoding", "ubuntu", "optimization", "java",
    "if-statement", "pickle", "pycharm", "exception-handling", "user-interface", "pyramid", "indexing", "python-sphinx", "set", "split",
    "tornado", "lambda", "sqlite3", "image-processing", "iterator", "apache", "mocking", "debugging", "http", "apache-spark", "matlab",
    "urllib", "forms", "object", "iteration", "mysql-python", "sympy", "r", "elementtree", "slice", "testing",
    "heroku", "path", "floating-point", "twitter", "pyside", "gtk", "replace", "nlp", "distutils", "methods",
    "pygtk", "kivy", "django-queryset", "time", "coding-style", "rest", "email", "jquery", "vim", "orm",
    "networkx", "while-loop", "amazon-web-services", "psycopg2", "templates", "itertools", "date", "ssh", "mechanize", "web-crawler",
    "memory", "php", "py.test", "popen", "git", "ipython-notebook", "fabric", "scope", "paramiko", "multidimensional-array",
    "arguments", "string-formatting", "ajax", "openerp", "perl", "api", "swig", "text", "mod-wsgi", "html-parsing",
    "pyspark", "pyparsing", "boto", "printing", "anaconda", "statistics", "python-3.4", "graph", "pydev", "url", "py2exe", "python-2.6",
    "parallel-processing", "serialization", "ruby", "networking", "stdout", "boolean", "command-line", "c#", "functional-programming", "boost-python",
    "unix", "raspberry-pi", "python-internals", "data-structures", "jython", "io", "character-encoding", "time-series", "nose", "nginx",
    "uwsgi", "types", "input", "search", "attributes", "documentation", "hash", "eclipse", "ssl", "package",
    "append", "metaclass", "tensorflow", "theano", "android", "easy-install", "boost", "queue",
    "pdb", "emacs", "pipe", "bottle", "tweepy"]

//
// Initialization tasks
//
outputLabel([])

var net = loadNetwork()

</script>
</html>
