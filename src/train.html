<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./../stylesheets/bootstrap.min.css">

    <script src="./../lib/convnet-min.js"></script>
    <script src="./../lib/20160515-convnet-param.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<style>

    html {
        font-family: Lucida Grande, sans-serif;
        -ms-text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
    }

    path {
		stroke: black;
		stroke-width: 1;
	    fill: none;
	}

	.axis {
		shape-rendering: crispEdges;
	}

</style>

</head>

<body>

    <!--Header-->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container-fluid">

            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">Code Snippet Classifier</a>
            </div>

            <div class="navbar-collapse navbar-responsive-collapse">

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="./src/about.html">About</a></li>
                </ul>

            </div>
        </div>
    </nav>

    <!--Body-->
    <div class="container">
        <div class="panel-group">

            <!--Input Box-->
            <div class="col-xs-4"><div class="panel panel-default">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <a onclick="onclick_handler('continue')"><span class="label label-default">Continue</span></a>
                    </div>

                    <div class="panel-title pull-right">
                        <a onclick="onclick_handler('reset')"><span class="label label-danger">Reset</span></a>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body" id="input_panel">
                    <div class="form-group">
                        <textarea id="user_input" onkeyup="onkey_handler(event)" class="form-control" rows="15"></textarea>
                    </div>
                </div>

            </div></div>

            <!--Output Box-->
            <div class="col-xs-8"><div class="panel panel-primary">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <span class="label label-default">Output</span>
                    </div>

                    <div class="panel-title pull-right">
                        <a id="download"><span class="label label-default">Save</span></a>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body" id="output_panel" style="min-height: 325px; word-wrap: break-word">
                    <div id="user_output"></div>
                </div>

            </div></div>

            <br>&nbsp;<br>

            <!--Input Box-->
            <div class="col-xs-12"><div class="panel panel-default">

                <div class="panel-heading">
                    <div class="panel-title pull">
                        <span class="label label-default">Progress</span>
                    </div>
                </div>

                <div class="panel-body" id="progress_panel">
                    <div class="form-group">
                    </div>
                </div>

            </div></div>

        </div>
    </div>

    <br>&nbsp;<br>

</body>

<script>

//
// Input callback
//
var onclick_handler = function(input) {

    // Reset labels
    outputLabel([])

    // Initialize network
    switch (input) {

        case 'continue':
            var net = loadNetwork()
            break;

        case 'reset':
            var net = initializeNetwork()
            break;
    }

    trainNetwork(net, 50000)
}

//
// Keyboard callback
//
var onkey_handler = function(event) {

    // Check if input is empty
    if (document.getElementById("user_input").value == "") {
        outputLabel([])
    }
}

//
// Parse input
//
var parseInput = function (input) {

    // Valid characters
    grammar = /([a-z0-9.,;:'"<>{}\(\)!?\[\]\-\+\*\^\#\!\&\_\=\/\|\`\~\\]+)/gi

    //
    // Text preprocessing
    //
    text  = []

    // 1) Remove all spaces (keep newline and tabs)
    if (input.length > 0) {
        input = input.replace(/[ ]+/g, '')
    } else {
        return
    }

    // 2) Convert to lower case
    if (input.length > 0) {
        input = input.toLowerCase(text)
    } else {
        return
    }

    // 3) Check for " at start/end (artifacts of copy/paste)
    if (input.charAt(0) == '"') {
        input = input.substr(1)
    }

    if (input.charAt(input.length-1) == '"') {
        input = input.substr(0, input.length-1)
    }

    // 4) Parse input (group by lines, max length of 50 characters)
    while ((x = grammar.exec(input))) {
        text.push(x[0].substr(0,50))
    }

    // 5) Keep the first 25 lines
    if (text.length > 25) {
        text = text.slice(0, 24)
    }

    // 6) Convert characters to integers (char --> charcode)
    var output = []

    for (var i = 0; i < text.length; i++) {
        for (var j = 0; j < text[i].length; j++) {

            if (j == 0) {
                output[i] = []
            }

            output[i].push(text[i].charCodeAt(j)*2)
        }
    }

    // 7) Zero padding (fill each array to 50 total elements with zeros)
    for (var i = 0; i < output.length; i++) {

        if (output[i].length < 50) {
            var x = output[i].length

            for (var j = 0; j < 50 - x; j++) {
                output[i].push(0)
            }
        }
    }

    return output
}

//
// Load network
//
var loadNetwork = function () {

    var net = new convnetjs.Net();
    net.fromJSON(netParam);

    return net
}

//
// Initialize network
//
var initializeNetwork = function (input) {

    //
    // Layers
    //
    layer = {}

    // Input size [sx, sy]
    layer.input = [50, 25]

    // Convolution size and filters [sx, filters]
    layer.conv1 = [10, 100]
    layer.conv2 = [5, 15]
    layer.conv3 = [3, 30]
    layer.conv4 = [5, 15]

    // Pooling size [sx]
    layer.pool1 = 5
    layer.pool2 = 3
    layer.pool3 = 3
    layer.pool4 = 3

    // Softmax classes [classes]
    layer.classes = 250

    var layer_defs = []

    layer_defs.push({type: 'input', out_sx: layer.input[0], out_sy: layer.input[1], out_depth: 1})

    layer_defs.push({type: 'conv', sx: layer.conv1[0], filters: layer.conv1[1], stride: 2, pad: 2, activation: 'relu'})
    layer_defs.push({type: 'pool', sx: layer.pool1, stride: 2})

    layer_defs.push({type: 'conv', sx: layer.conv2[0], filters: layer.conv2[1], stride: 1, pad: 2, activation: 'relu'})
    layer_defs.push({type: 'pool', sx: layer.pool2, stride: 2})

    //layer_defs.push({type: 'conv', sx: layer.conv3[0], filters: layer.conv3[1], stride: 1, pad: 2, activation: 'relu'})
    //layer_defs.push({type: 'pool', sx: layer.pool3, stride: 2})

    //layer_defs.push({type: 'conv', sx: layer.conv4[0], filters: layer.conv4[1], stride: 1, pad: 2, activation: 'relu'})
    //layer_defs.push({type: 'pool', sx: layer.pool4, stride: 2})

    layer_defs.push({type: 'softmax', num_classes: layer.classes})

    // Initialize network
    net = new convnetjs.Net()
    net.makeLayers(layer_defs)

    return net
}

//
// Train network
//
var trainNetwork = function (net, rounds) {

    train = {}

    train.method = 'sgd'
    train.batch  = 10
    train.learn  = 0.1
    train.l1     = 0.001
    train.l2     = 0.0001

    var trainer = new convnetjs.SGDTrainer(net, {
        method: train.method,
        batch_size: train.batch,
        learning_rate: train.learn,
        l1_decay: train.l1,
        l2_decay: train.l2});

    var lossXY = [{x: 0, y: 0}];
    var avgLoss = [];
    var avgL2 = [];

    d3.csv('./../data/stackoverflow_python_top250_55k.csv', function(data) {

        var counter = 0;

        for (var n = 0; n < rounds; n++) {

            var dataIndex = Math.floor(Math.random() * 54999);

            var trainText = data[dataIndex].postText
            var trainInput = parseInput(data[dataIndex].postText)
            var trainOutput = parseInt(data[dataIndex].postLabel)

            var trainData = new convnetjs.Vol(50, 25, 1, 0.0);
            trainData = formatData(trainInput, trainData)

            var stats = trainer.train(trainData, trainOutput)
            counter += 1

            avgLoss.push(stats.loss)
            avgL2.push(stats.l2_decay_loss)

            if (counter % 100 == 0) {

                var sum = avgLoss.reduce(function(a, b) { return a + b; });
                var avg = sum / avgLoss.length;
                var avgLoss10 = (Math.round(avg * 10000) / 10000)

                sum = avgL2.reduce(function(a, b) { return a + b; });
                avg = sum / avgL2.length;
                var avgL210 = (Math.round(avg * 10000) / 10000)

                avgLoss = []
                avgL2 = []

                var progress = (Math.round((counter/rounds) * 100000) / 100000)*100

                console.log(progress, avgLoss10, avgL210)
                //lossXY.push({x: counter, y: stats.loss})
            }
        }
    });

    updateCheckpoint(net)
}

//
// Download model
//
var updateCheckpoint = function(net) {

    var json = JSON.stringify(net.toJSON());
    var blob = new Blob([json], {type: "application/json"});
    var url  = URL.createObjectURL(blob);

    document.getElementById("download").download = 'stackoverflow_python_model.json'
    document.getElementById("download").href = url
}

//
// Format data
//
var formatData = function (input, data) {

    for (var i = 0; i < input.length; i++) {
        for (var j = 0; j < input[i].length; j++) {
            data.set(i, j, 1, input[i][j])
        }
    }

    return data
}

//
// Classification table
//
var outputLabel = function (input) {

    var x = ' '

    // Construct HTML table
    for (var i = 0; i < labelKey.length; i++) {

        if (input.indexOf(i+1) >= 0) {
            x = x.concat('<span class="label label-success">', labelKey[i], '</span>\n')
        } else {
            x = x.concat('<span class="label label-default">', labelKey[i], '</span>\n')
        }
    }

    document.getElementById("user_output").innerHTML = x
}

//
// Parse output
//
var getLabel = function(output) {

    if (output >= 1 & output <= 250) {
        return labelKey[output-1]
    } else {
        return ""
    }
}

//
// Initialize plot
//
var initializePlot = function() {

    var margin = {top: 30, right: 20, bottom: 30, left: 50};
    var width = 600 - margin.left - margin.right;
    var height = 270 - margin.top - margin.bottom;

    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    var xAxis = d3.svg.axis().scale(x)
        .orient("bottom").ticks(5);

    var yAxis = d3.svg.axis().scale(y)
        .orient("left").ticks(5);

    var svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
}

//
// Key to label
//
var labelKey = [
    "django", "numpy", "pandas", "python-2.7", "list", "python-3.x", "matplotlib", "regex", "dictionary", "string",
    "arrays", "flask", "google-app-engine", "sqlalchemy", "scipy", "tkinter", "csv", "django-models", "json", "beautifulsoup",
    "mysql", "multithreading", "pip", "datetime", "subprocess", "scrapy", "unicode", "xml", "linux", "html", "unit-testing",
    "selenium", "performance", "class", "multiprocessing", "algorithm", "windows", "dataframe", "sorting", "c++", "osx",
    "opencv", "pyqt", "file", "function", "scikit-learn", "pygame", "parsing", "list-comprehension", "virtualenv", "logging",
    "sockets", "import", "tuples", "loops", "web-scraping", "django-templates", "mongodb", "lxml", "postgresql", "plot",
    "sql", "ipython", "javascript", "python-imaging-library", "module", "c", "django-rest-framework", "exception", "for-loop", "recursion", "cython",
    "oop", "python-requests", "django-forms", "django-admin", "wxpython", "argparse", "celery", "bash", "qt", "pyqt4",
    "ctypes", "matrix", "selenium-webdriver", "generator", "math", "decorator", "sqlite", "urllib2", "jinja2", "shell", "nltk",
    "file-io", "random", "inheritance", "python-import", "setuptools", "twisted", "image", "xpath", "python-2.x", "flask-sqlalchemy",
    "variables", "database", "excel", "pymongo", "machine-learning", "syntax", "utf-8", "encoding", "ubuntu", "optimization", "java",
    "if-statement", "pickle", "pycharm", "exception-handling", "user-interface", "pyramid", "indexing", "python-sphinx", "set", "split",
    "tornado", "lambda", "sqlite3", "image-processing", "iterator", "apache", "mocking", "debugging", "http", "apache-spark", "matlab",
    "urllib", "forms", "object", "iteration", "mysql-python", "sympy", "r", "elementtree", "slice", "testing",
    "heroku", "path", "floating-point", "twitter", "pyside", "gtk", "replace", "nlp", "distutils", "methods",
    "pygtk", "kivy", "django-queryset", "time", "coding-style", "rest", "email", "jquery", "vim", "orm",
    "networkx", "while-loop", "amazon-web-services", "psycopg2", "templates", "itertools", "date", "ssh", "mechanize", "web-crawler",
    "memory", "php", "py.test", "popen", "git", "ipython-notebook", "fabric", "scope", "paramiko", "multidimensional-array",
    "arguments", "string-formatting", "ajax", "openerp", "perl", "api", "swig", "text", "mod-wsgi", "html-parsing",
    "pyspark", "pyparsing", "boto", "printing", "anaconda", "statistics", "python-3.4", "graph", "pydev", "url", "py2exe", "python-2.6",
    "parallel-processing", "serialization", "ruby", "networking", "stdout", "boolean", "command-line", "c#", "functional-programming", "boost-python",
    "unix", "raspberry-pi", "python-internals", "data-structures", "jython", "io", "character-encoding", "time-series", "nose", "nginx",
    "uwsgi", "types", "input", "search", "attributes", "documentation", "hash", "eclipse", "ssl", "package",
    "append", "metaclass", "tensorflow", "theano", "android", "easy-install", "boost", "queue",
    "pdb", "emacs", "pipe", "bottle", "tweepy"]

//
// Initialization tasks
//
outputLabel([])

</script>
</html>
