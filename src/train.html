<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./../stylesheets/bootstrap.min.css">

    <script src="./../lib/convnet-min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<style>

    html {
        font-family: Lucida Grande, sans-serif;
        -ms-text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
    }

</style>

</head>

<body>

    <!--Header-->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container-fluid">

            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">Code Snippet Classifier</a>
            </div>

            <div class="navbar-collapse navbar-responsive-collapse">

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="./src/about.html">About</a></li>
                </ul>

            </div>
        </div>
    </nav>

    <!--Body-->
    <div class="container">
        <div class="panel-group">

            <!--Input Box-->
            <div class="col-xs-4"><div class="panel panel-default">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <span class="label label-default" align="left">Input</span>
                        <span class="label label-success" align="left">Python</span>
                    </div>

                    <div class="panel-title pull-right">
                        <a onclick="loadExample('1')"><span class="label label-default" align="left">Train</span></a>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body">
                    <div class="form-group">
                        <textarea id="user_input" onkeyup="onkey_handler(event)" class="form-control" rows="10" placeholder="Paste code snippet here..."></textarea>
                    </div>

                    <button type="button" onclick="onclick_handler()" class="btn btn-primary btn-sm btn-block">Start</button>

                </div>

            </div></div>

            <!--Output Box-->
            <div class="col-xs-8"><div class="panel panel-primary">

                <div class="panel-heading">

                    <div class="panel-title pull-left">
                        <span class="label label-default" align="left">Output</span>
                    </div>

                    <div class="panel-title pull-right">
                        <span class="label label-danger">Demo</span>
                    </div>

                    <div class="clearfix"></div>
                </div>

                <div class="panel-body" style="min-height: 325px; word-wrap: break-word">
                    <div id="user_output"></div>
                </div>

            </div></div>

        </div>
    </div>

    <br>&nbsp;<br>

    <div id="content"></div>

</body>

<script>

//
// Input callback
//
var onclick_handler = function() {

    // User input
    input = document.getElementById("user_input").value

    // Reset labels
    outputLabel([])

    // Start training
    var net = initializeNet()
}

//
// Keyboard callback
//
var onkey_handler = function(event) {

    // Check if input is empty
    if (document.getElementById("user_input").value == "") {
        outputLabel([])
    }
}

//
// Examples
//
var loadExample = function (input) {

    var example = {}
    example.input1  = `x=[]\nx.append(3)\nx.append(7)\n\nfor i in range(1, 20):\n    x[i] = x[i-1]+(i+1)`

    switch (input) {
        case '1':
            document.getElementById("user_input").value = example.input1
            break;
        }
}

//
// Parse input
//
var parseInput = function (input) {

    // User input
    if (typeof input == null) {
        input = document.getElementById("user_input").value
    }

    // Valid characters
    grammar = /([a-z0-9.,;:'"<>{}\(\)!?\[\]\-\+\*\^\#\!\&\_\=\/\|\`\~\\]+)/gi

    //
    // Text preprocessing
    //
    text  = []

    // 1) Remove all spaces
    if (input.length > 0) {
        input = input.replace(/[ ]+/g, '')
    } else {
        return
    }

    // 2) Convert to lower case
    if (input.length > 0) {
        input = input.toLowerCase(text)
    } else {
        return
    }

    // 3) Check for " at start/end
    if (input.charAt(0) == '"') {
        input = input.substr(1)
    }

    if (input.charAt(input.length-1) == '"') {
        input = input.substr(0, input.length-1)
    }

    // 4) Parse input
    while ((x = grammar.exec(input))) {
        text.push(x[0].substr(0,50))
    }

    // 5) Convert characters to integers
    var output = []

    for (var i = 0; i < text.length; i++) {
        for (var j = 0; j < text[i].length; j++) {

            if (j == 0) {
                output[i] = []
            }

            output[i].push(text[i].charCodeAt(j))
        }
    }

    // 6) Zero padding
    for (var i = 0; i < output.length; i++) {

        if (output[i].length < 50) {
            var x = output[i].length

            for (var j = 0; j < 50 - x; j++) {
                output[i].push(0)
            }
        }
    }

    return output
}

//
// Initialize convolutional neural network
//
var initializeNet = function (input) {

    //
    // Layers
    //
    layer = {}

    // Input size [sx, sy]
    layer.input = [50, 25]

    // Convolution size and filters [sx, filters]
    layer.conv1 = [2, 25]
    layer.conv2 = [3, 50]
    layer.conv3 = [5, 25]

    // Pooling size [sx]
    layer.pool1 = 2
    layer.pool2 = 3
    layer.pool3 = 3

    // Softmax classes [classes]
    layer.classes = 250

    var layer_defs = []

    layer_defs.push({type: 'input', out_sx: layer.input[0], out_sy: layer.input[1], out_depth: 1})

    layer_defs.push({type: 'conv', sx: layer.conv1[0], filters: layer.conv1[1], stride: 1, pad: 2, activation: 'relu'})
    layer_defs.push({type: 'pool', sx: layer.pool1, stride: 2})

    layer_defs.push({type: 'conv', sx: layer.conv2[0], filters: layer.conv2[1], stride: 1, pad: 2, activation: 'relu'})
    layer_defs.push({type: 'pool', sx: layer.pool2, stride: 2})

    layer_defs.push({type: 'conv', sx: layer.conv3[0], filters: layer.conv3[1], stride: 1, pad: 2, activation: 'relu'})
    layer_defs.push({type: 'pool', sx: layer.pool3, stride: 2})

    layer_defs.push({type: 'softmax', num_classes: layer.classes})

    // Initialize network
    net = new convnetjs.Net()
    net.makeLayers(layer_defs)

    //
    // Training
    //
    train = {}

    train.method = 'adadelta'
    train.batch  = 5
    train.learn  = 0.01
    train.l1     = 0.000
    train.l2     = 0.001

    var trainer = new convnetjs.Trainer(net, {
        method: train.method,
        batch_size: train.batch,
        learning_rate: train.learn,
        //l1_decay: train.l1,
        l2_decay: train.l2});

    d3.csv('./../data/stackoverflow_python_top250_55k.csv', function(csv) {

        var data = csv;

        var counter = 0
        var rounds = 2

        for (var n = 0; n < rounds; n++) {
            for (var i = 0; i < data.length; i++) {

                dataIndex = Math.floor(Math.random() * 54999);

                var trainText = data[dataIndex].postText
                var trainInput = parseInput(data[dataIndex].postText)
                var trainOutput = parseInt(data[dataIndex].postLabel)

                var trainData = new convnetjs.Vol(50, 25, 1, 0.0);
                trainData = fill(trainInput, trainData)

                var stats = trainer.train(trainData, trainOutput)

                counter += 1

                if (counter > 100) {
                    console.log(i,stats.loss)
                    counter = 1
                }
            }
        }

        document.getElementById("user_input").value = trainText

        var testData = net.forward(trainData)
        var testIndex = []

        for (var j = 0; j < testData.w.length; j++) {
            if (testData.w[j] > 0.015) {
                testIndex.push(j)
            }
        }

        outputLabel(testIndex)
    })

    var json = net.toJSON();
    var str = JSON.stringify(json);

    var blob = new Blob([str], {type: "application/json"});
    var url  = URL.createObjectURL(blob);

    var a = document.createElement('a');
    a.download    = "model.json";
    a.href        = url;
    a.textContent = "Download";

    document.getElementById('content').appendChild(a);
}

//
// Format data
//
var fill = function (input, volume) {

    for (var i = 0; i < input.length; i++) {
        for (var j = 0; j < input[i].length; j++) {
            volume.set(i, j, 1, input[i][j])
        }
    }

    return volume
}

//
// Classification table
//
var outputLabel = function (input) {

    var x = ' '

    // Construct HTML table
    for (var i = 0; i < labelKey.length; i++) {

        if (input.indexOf(i+1) >= 0) {
            x = x.concat('<span class="label label-success">', labelKey[i], '</span>\n')
        } else {
            x = x.concat('<span class="label label-default">', labelKey[i], '</span>\n')
        }
    }

    // Update HTML table
    document.getElementById("user_output").innerHTML = x

}

//
// Parse output
//
var getLabel = function(output) {

    if (output >= 1 & output <= 250) {
        return labelKey[output-1]
    } else {
        return ""
    }
}

//
// Key to label
//
var labelKey = [
    "django", "numpy", "pandas", "python-2.7", "list", "python-3.x", "matplotlib", "regex", "dictionary", "string",
    "arrays", "flask", "google-app-engine", "sqlalchemy", "scipy", "tkinter", "csv", "django-models", "json", "beautifulsoup",
    "mysql", "multithreading", "pip", "datetime", "subprocess", "scrapy", "unicode", "xml", "linux", "html", "unit-testing",
    "selenium", "performance", "class", "multiprocessing", "algorithm", "windows", "dataframe", "sorting", "c++", "osx",
    "opencv", "pyqt", "file", "function", "scikit-learn", "pygame", "parsing", "list-comprehension", "virtualenv", "logging",
    "sockets", "import", "tuples", "loops", "web-scraping", "django-templates", "mongodb", "lxml", "postgresql", "plot",
    "sql", "ipython", "javascript", "python-imaging-library", "module", "c", "django-rest-framework", "exception", "for-loop", "recursion", "cython",
    "oop", "python-requests", "django-forms", "django-admin", "wxpython", "argparse", "celery", "bash", "qt", "pyqt4",
    "ctypes", "matrix", "selenium-webdriver", "generator", "math", "decorator", "sqlite", "urllib2", "jinja2", "shell", "nltk",
    "file-io", "random", "inheritance", "python-import", "setuptools", "twisted", "image", "xpath", "python-2.x", "flask-sqlalchemy",
    "variables", "database", "excel", "pymongo", "machine-learning", "syntax", "utf-8", "encoding", "ubuntu", "optimization", "java",
    "if-statement", "pickle", "pycharm", "exception-handling", "user-interface", "pyramid", "indexing", "python-sphinx", "set", "split",
    "tornado", "lambda", "sqlite3", "image-processing", "iterator", "apache", "mocking", "debugging", "http", "apache-spark", "matlab",
    "urllib", "forms", "object", "iteration", "mysql-python", "sympy", "r", "elementtree", "slice", "testing",
    "heroku", "path", "floating-point", "twitter", "pyside", "gtk", "replace", "nlp", "distutils", "methods",
    "pygtk", "kivy", "django-queryset", "time", "coding-style", "rest", "email", "jquery", "vim", "orm",
    "networkx", "while-loop", "amazon-web-services", "psycopg2", "templates", "itertools", "date", "ssh", "mechanize", "web-crawler",
    "memory", "php", "py.test", "popen", "git", "ipython-notebook", "fabric", "scope", "paramiko", "multidimensional-array",
    "arguments", "string-formatting", "ajax", "openerp", "perl", "api", "swig", "text", "mod-wsgi", "html-parsing",
    "pyspark", "pyparsing", "boto", "printing", "anaconda", "statistics", "python-3.4", "graph", "pydev", "url", "py2exe", "python-2.6",
    "parallel-processing", "serialization", "ruby", "networking", "stdout", "boolean", "command-line", "c#", "functional-programming", "boost-python",
    "unix", "raspberry-pi", "python-internals", "data-structures", "jython", "io", "character-encoding", "time-series", "nose", "nginx",
    "uwsgi", "types", "input", "search", "attributes", "documentation", "hash", "eclipse", "ssl", "package",
    "append", "metaclass", "tensorflow", "theano", "android", "easy-install", "boost", "queue",
    "pdb", "emacs", "pipe", "bottle", "tweepy"]

//
// Initialization tasks
//
outputLabel([])

</script>
</html>
